manifest {
  description = 'dockerised KDM pipeline'
}

params {
	input = "${projectDir}/sample_list.csv"
	outdir = "${projectDir}/Final_Output"
	bedfile = "${projectDir}/assets/ablnew_sortd.bed"
	annovar_humandb = "${projectDir}/assets/humandb"
	gen_ref = "${projectDir}/assets/gene_fullxref.txt"
	adaptors = "${projectDir}/assets/TruSeq2-PE.fa"
	site2 = "${projectDir}/assets/dbsnp_138.hg19.vcf"
	site2_idx  = "${projectDir}/assets/dbsnp_138.hg19.vcf.idx"
	site1 = "${projectDir}/assets/Mills_and_1000G_gold_standard.indels.hg19.sites.vcf"
	site1_idx  = "${projectDir}/assets/Mills_and_1000G_gold_standard.indels.hg19.sites.vcf.idx"
	site3 = "${projectDir}/assets/1000G_phase1.snps.high_confidence.hg19.sites.vcf"
	genome_minimap_getitd = "${projectDir}/assets/hg37.fa"
	genome = "${projectDir}/assets/hg19_all.fasta"
	genome_dir = new File(genome).parent
	ind_files = new File(genome).name
	sequences = "${projectDir}/sequences/"
	mutect2 = "mutect2"
	vardict = "vardict"
	lofreq  = "lofreq"
	varscan = "varscan"
	trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')

	coverview_script_path = "/home/pipelines/mutation_detector_nextflow/scripts/coverview.py"
	coverview_report_path = "/home/pipelines/mutation_detector_nextflow/scripts/coverview_report.py"
	coverview_path = "/home/programs/CoverView-1.4.3" 

}

def humandb_real = new File(params.annovar_humandb).canonicalPath
def reffile_real = new File(params.gen_ref).canonicalPath

profiles {
	docker {
		docker.enabled = true
		docker.runOptions       = '-u $(id -u):$(id -g)'
	}	
	singularity {
		docker.enabled    = true
		docker.autoMounts = true
	}
}

process {
	resourceLimits = [ 
		memory: 500.GB,
		cpus: 100,
		time: 30.d
	]
	// TODO nf-core: Check the defaults for all processes
	// cpus   = { 1      * task.attempt }
	// memory = { 6.GB   * task.attempt }
	// time   = { 12.h    * task.attempt }

	errorStrategy = 'terminate'
	// maxRetries    = 1
	// maxErrors     = '-1'

	withLabel:process_single {
		cpus   = { 1                   }
		memory = { 6.GB * task.attempt }
		time   = { 16.h  * task.attempt }
	}
	withLabel:process_low {
		cpus   = { 8     * task.attempt }
		memory = { 12.GB * task.attempt }
		time   = { 16.h   * task.attempt }
	}
	withLabel:process_medium {
		cpus   = { 32     * task.attempt }
		memory = { 36.GB * task.attempt }
		time   = { 16.h   * task.attempt }
	}
	withLabel:process_high {
		cpus   = { 64    * task.attempt }
		memory = { 72.GB * task.attempt }
		time   = { 16.h  * task.attempt }
	}
	withLabel:process_long {
		time   = { 20.h  * task.attempt }
	}
	withLabel:process_high_memory {
		memory = { 200.GB * task.attempt }
	}

	withName:TRIM {
		container = 'quay.io/biocontainers/fastp:1.0.1--heae3180_0'
	}
	withName:/(MAPBAM|MINIMAP_SORT|ALIGNMENT)/ {
		container = 'dukegcb/bwa-samtools:latest'
	}
	withName:/(MARK_DUPS|ALIGNMENT_METRICS|INSERT_SIZE_METRICS)/ {
		container = 'quay.io/biocontainers/picard:3.1.0--hdfd78af_0'
	}
	withName:/(COVERAGE|BAM_TO_FASTQ|MINIMAP_BAMTOFASTQ)/ {
		container = 'quay.io/biocontainers/bedtools:2.31.1--h13024bc_3'
	}
	withName:VARDICT {
		container = 'quay.io/biocontainers/vardict-java:1.8.3--hdfd78af_0'
	}
	withName:LOFREQ {
		container = 'docker.io/kboltonlab/lofreq:1.0'
	}
	withName: /(BQSR|APPLY_BQSR|MUTECT)/ {
		container = 'quay.io/biocontainers/gatk4:4.3.0.0--py36hdfd78af_0'
	}
	withName:VARSCAN {
		container = 'gulnazzaidi/varscan:2.3.9'
	}
	withName:MINIMAP {
		container = 'staphb/minimap2:2.30'
	}
	withName:GETITD {
		container = 'gulnazzaidi/getitd_filt3r:v0.90'
	}
	withName:ANNOVAR {
		container = 'bioinfochrustrasbourg/annovar:2018Apr16'
		containerOptions = "-v ${humandb_real}:/databases/humandb -v ${reffile_real}:/databases/gene_fullxref.txt"
	}
	withName:/(FORMAT_VARDICT | FORMAT_LOFREQ | FORMAT_MUTECT | COMBINE_OUTPUT | MERGE_CSVS | COMBINE_REPLICATES )/ {
		container = 'docker.io/jupyter/scipy-notebook:x86_64-ubuntu-22.04'
	}
	withName: /(REALIGNER_TARGET_CREATOR|INDEL_REALIGNER|BASE_RECALIBRATOR|PRINT_READS)/ {
		container = "broadinstitute/gatk3:3.8-1"
	}
}

timeline {
	enabled = true
	file    = "${params.outdir}/pipeline_info/execution_timeline_${params.trace_timestamp}.html"
}
report {
	enabled = true
	file    = "${params.outdir}/pipeline_info/execution_report_${params.trace_timestamp}.html"
	overwrite = true
}
trace {
	enabled = true
	file = "${params.outdir}/pipeline_info/pipeline_trace_${params.trace_timestamp}.txt"
	fields = 'hash,task_id,name,status,exit,realtime,%cpu,rss'
}
dag {
	enabled = true
	file    = "${params.outdir}/pipeline_info/pipeline_dag_${params.trace_timestamp}.html"
}

